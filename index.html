<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BandSync - バンド日程調整ツール</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', 'Noto Sans JP', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .slot-transition { transition: background-color 0.15s ease, transform 0.1s ease; }
        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .animate-slide-up { animation: slideUp 0.3s ease-out forwards; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        const { useState, useEffect, useMemo, useCallback } = React;

        // --- Firebase Modules ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken,
            onAuthStateChanged, 
            GoogleAuthProvider, 
            signInWithPopup,
            signOut 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc, 
            collection, 
            onSnapshot, 
            updateDoc 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : {
                apiKey: "AIzaSyAtOjrOa6EBSmpzEb5xOQSOK6WmRl3ALVo", 
                authDomain: "bandschedule-98f2c.firebaseapp.com",
                projectId: "bandschedule-98f2c",
                storageBucket: "bandschedule-98f2c.firebasestorage.app",
                messagingSenderId: "1017107663135",
                appId: "1:1017107663135:web:54771b17cd463b32af482a"
            };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'band-sync-production-v9';

        // --- Global Helpers ---
        const formatDate = (date) => {
            const y = date.getFullYear();
            const m = (date.getMonth() + 1).toString().padStart(2, '0');
            const d = date.getDate().toString().padStart(2, '0');
            return `${y}-${m}-${d}`;
        };

        const getWeekDates = (startDate) => {
            const dates = [];
            const base = new Date(startDate);
            for (let i = 0; i < 7; i++) {
                const d = new Date(base);
                d.setDate(base.getDate() + i);
                dates.push(d);
            }
            return dates;
        };

        const generateId = () => Math.random().toString(36).substring(2, 11);

        // --- Icons ---
        const IconGoogle = () => <svg className="w-5 h-5 mr-2" viewBox="0 0 24 24"><path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z"/><path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>;
        const IconCopy = () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>;
        const IconLogout = () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>;
        const IconUsers = () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>;

        function App() {
            const [user, setUser] = useState(null);
            const [isAuthLoading, setIsAuthLoading] = useState(true);
            const [error, setError] = useState(null);
            const [sessionId, setSessionId] = useState(new URLSearchParams(window.location.search).get('s') || null);
            const [sessionData, setSessionData] = useState(null);
            const [allAvailability, setAllAvailability] = useState([]);
            const [userName, setUserName] = useState('');
            const [isJoined, setIsJoined] = useState(false);
            const [isJoining, setIsJoining] = useState(false);
            const [viewStartDate, setViewStartDate] = useState(new Date());
            const [selectionStart, setSelectionStart] = useState(null);
            const [activeDetailSlot, setActiveDetailSlot] = useState(null);

            // --- 認証状態の監視 ---
            useEffect(() => {
                const unsub = onAuthStateChanged(auth, (u) => {
                    setUser(u);
                    setIsAuthLoading(false);
                    // Googleログイン成功時に名前を自動セット
                    if (u && !userName) {
                        setUserName(u.displayName || '');
                    }
                });
                return () => unsub();
            }, [userName]);

            // --- Firestoreデータ購読 (RULE 1, 2, 3) ---
            useEffect(() => {
                if (!user || !sessionId) return;

                // セッション取得
                const sessionsCol = collection(db, 'artifacts', appId, 'public', 'data', 'sessions');
                const sessionRef = doc(sessionsCol, sessionId);
                
                const unsubSession = onSnapshot(sessionRef, (snap) => {
                    if (snap.exists()) setSessionData(snap.data());
                    else setError("セッションが見つかりませんでした。");
                }, (err) => {
                    console.error("Session Error:", err);
                    setError("データの読み取り権限がありません。");
                });

                // 参加者情報取得 (RULE 1: フラットパス)
                const availCol = collection(db, 'artifacts', appId, 'public', 'data', 'availability');
                const unsubAvail = onSnapshot(availCol, (snap) => {
                    const docs = [];
                    snap.forEach(d => docs.push({ id: d.id, ...d.data() }));
                    
                    // RULE 2: クライアント側でフィルタリング
                    const filtered = docs.filter(item => item.sessionId === sessionId);
                    setAllAvailability(filtered);
                    
                    // すでに参加しているか確認
                    const me = filtered.find(item => item.uid === user.uid);
                    if (me) {
                        setIsJoined(true);
                        setUserName(me.name);
                    }
                }, (err) => console.error("Avail Error:", err));

                return () => { unsubSession(); unsubAvail(); };
            }, [user, sessionId]);

            const loginWithGoogle = async () => {
                const provider = new GoogleAuthProvider();
                try {
                    setError(null);
                    const result = await signInWithPopup(auth, provider);
                    if (result.user) setUserName(result.user.displayName || '');
                } catch (e) {
                    setError(`Googleログイン失敗: ${e.message}`);
                }
            };

            const loginAnonymously = async () => {
                try { 
                    setError(null);
                    await signInAnonymously(auth); 
                } catch (e) { 
                    setError("ログインに失敗しました。"); 
                }
            };

            const handleLogout = async () => {
                if (confirm("ログアウトしますか？")) {
                    await signOut(auth);
                    window.location.reload();
                }
            };

            const handleCreate = async (bandName, count) => {
                if (!user) return;
                const id = generateId();
                const data = {
                    id, bandName, memberCount: parseInt(count),
                    startDate: formatDate(new Date()), createdAt: Date.now(), creatorUid: user.uid
                };
                try {
                    const sessionRef = doc(db, 'artifacts', appId, 'public', 'data', 'sessions', id);
                    await setDoc(sessionRef, data);
                    setSessionId(id);
                    // 履歴操作を完全に排除（エラー回避）
                } catch (e) { setError(`作成失敗: ${e.message}`); }
            };

            const handleJoin = async () => {
                if (!userName || !userName.trim() || !user || !sessionId) return;
                setIsJoining(true);
                try {
                    // ユニークな参加ID（sessionId_uid）
                    const docId = `${sessionId}_${user.uid}`;
                    const ref = doc(db, 'artifacts', appId, 'public', 'data', 'availability', docId);
                    
                    const myExistingData = allAvailability.find(a => a.uid === user.uid);
                    
                    await setDoc(ref, { 
                        sessionId,
                        uid: user.uid,
                        name: userName.trim(), 
                        slots: myExistingData?.slots || [],
                        photoURL: user.photoURL || null,
                        lastUpdated: Date.now()
                    }, { merge: true });
                    
                    setIsJoined(true);
                } catch (e) { 
                    console.error("Join write error:", e);
                    setError(`カレンダーの表示に失敗しました。名前を再入力して試してください。`); 
                } finally {
                    setIsJoining(false);
                }
            };

            const handleSlotClick = async (dateStr, slotIdx) => {
                if (!isJoined || !user || !sessionId) return;
                const key = `${dateStr}:${slotIdx}`;
                setActiveDetailSlot(key);

                const docId = `${sessionId}_${user.uid}`;
                const ref = doc(db, 'artifacts', appId, 'public', 'data', 'availability', docId);
                const myData = allAvailability.find(a => a.uid === user.uid);
                const myCurrentSlots = myData?.slots || [];
                const amISelected = myCurrentSlots.includes(key);

                let nextSlots;
                if (!selectionStart || selectionStart.dateStr !== dateStr) {
                    nextSlots = amISelected ? myCurrentSlots.filter(s => s !== key) : [...myCurrentSlots, key];
                    setSelectionStart({ dateStr, slotIdx, wasSelected: amISelected });
                } else {
                    const start = Math.min(selectionStart.slotIdx, slotIdx);
                    const end = Math.max(selectionStart.slotIdx, slotIdx);
                    const rangeKeys = [];
                    for (let i = start; i <= end; i++) rangeKeys.push(`${dateStr}:${i}`);
                    nextSlots = selectionStart.wasSelected 
                        ? myCurrentSlots.filter(s => !rangeKeys.includes(s))
                        : [...new Set([...myCurrentSlots, ...rangeKeys])];
                    setSelectionStart(null);
                }
                try { await updateDoc(ref, { slots: nextSlots }); } catch (e) {}
            };

            const slotDetails = useMemo(() => {
                const map = {};
                allAvailability.forEach(data => {
                    data.slots?.forEach(slotKey => {
                        if (!map[slotKey]) map[slotKey] = [];
                        map[slotKey].push({ uid: data.uid, name: data.name, photoURL: data.photoURL });
                    });
                });
                return map;
            }, [allAvailability]);

            if (error) return <ErrorView message={error} onRetry={() => { setError(null); window.location.reload(); }} />;
            if (isAuthLoading) return <LoadingView />;
            if (!user) return <AuthGate onGoogle={loginWithGoogle} onAnon={loginAnonymously} />;
            if (!sessionId) return <Landing onCreate={handleCreate} user={user} onGoogleLogin={loginWithGoogle} onLogout={handleLogout} />;
            if (!sessionData) return <LoadingView />;

            if (!isJoined) return (
                <JoinView 
                    bandName={sessionData.bandName} 
                    userName={userName} 
                    setUserName={setUserName} 
                    onJoin={handleJoin}
                    user={user}
                    onGoogleLogin={loginWithGoogle}
                    isJoining={isJoining}
                />
            );

            const START_HOUR_VAL = 8;
            const weekDates = getWeekDates(viewStartDate);
            const activeParticipants = activeDetailSlot ? (slotDetails[activeDetailSlot] || []) : [];

            return (
                <div className="min-h-screen bg-white flex flex-col font-sans max-h-screen overflow-hidden relative text-slate-900">
                    <header className="px-4 py-3 border-b flex justify-between items-center bg-white z-40 shrink-0 shadow-sm text-left">
                        <div className="min-w-0">
                            <div className="font-black text-lg text-indigo-600 truncate leading-tight">{sessionData.bandName}</div>
                            <div className="text-[10px] text-slate-400 font-bold uppercase tracking-wider flex items-center gap-2">
                                <span>目標: <span className="text-slate-600">{sessionData.memberCount}人</span></span>
                                <span>参加: <span className="text-indigo-600">{allAvailability.length}人</span></span>
                            </div>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={() => {
                                const url = window.location.origin + window.location.pathname + '?s=' + sessionId;
                                const t = document.createElement('textarea');
                                t.value = url; document.body.appendChild(t); t.select();
                                document.execCommand('copy'); document.body.removeChild(t);
                                alert('共有URLをコピーしました！メンバーに送ってください。');
                            }} className="p-2.5 bg-indigo-50 text-indigo-600 rounded-xl hover:bg-indigo-100 transition-colors">
                                <IconCopy />
                            </button>
                            <button onClick={handleLogout} className="p-2.5 bg-slate-50 text-slate-400 rounded-xl hover:bg-rose-50 hover:text-rose-500 transition-colors">
                                <IconLogout />
                            </button>
                        </div>
                    </header>

                    <div className="flex items-center justify-between px-4 py-2 border-b bg-slate-50 shrink-0">
                        <button onClick={() => { const d = new Date(viewStartDate); d.setDate(d.getDate() - 7); setViewStartDate(d); }} className="text-xs font-black text-slate-400 p-1">← 前週</button>
                        <span className="font-black text-sm text-slate-700">{viewStartDate.toLocaleDateString('ja-JP', { year: 'numeric', month: 'short' })}</span>
                        <button onClick={() => { const d = new Date(viewStartDate); d.setDate(d.getDate() + 7); setViewStartDate(d); }} className="text-xs font-black text-slate-400 p-1">次週 →</button>
                    </div>

                    <div className="flex-1 flex flex-col overflow-y-auto no-scrollbar pb-24 text-left">
                        <div className="w-full flex border-b sticky top-0 bg-white z-10 shadow-sm">
                            <div className="w-12 shrink-0 border-r bg-slate-50"></div>
                            {weekDates.map((d, i) => (
                                <div key={i} className="flex-1 py-2 text-center border-r last:border-r-0">
                                    <div className={`text-[10px] font-bold ${d.getDay() === 0 ? 'text-rose-500' : d.getDay() === 6 ? 'text-blue-500' : 'text-slate-400'}`}>{DAYS_OF_WEEK[d.getDay()]}</div>
                                    <div className="font-black text-sm text-slate-700">{d.getDate()}</div>
                                </div>
                            ))}
                        </div>

                        <div className="flex w-full relative">
                            <div className="w-12 shrink-0 bg-slate-50/50 border-r text-[9px] text-slate-400 font-black">
                                {Array.from({ length: 23 - 8 + 1 }).map((_, h) => (
                                    <div key={h} className="h-12 flex items-start justify-center pt-2 border-b border-slate-100">{8 + h}:00</div>
                                ))}
                            </div>
                            <div className="flex-1 flex">
                                {weekDates.map((d, dayIdx) => {
                                    const ds = formatDate(d);
                                    return (
                                        <div key={dayIdx} className="flex-1 border-r last:border-r-0 flex flex-col">
                                            {Array.from({ length: TOTAL_SLOTS }).map((_, sIdx) => {
                                                const key = `${ds}:${sIdx}`;
                                                const participants = slotDetails[key] || [];
                                                const count = participants.length;
                                                const isMe = allAvailability.find(a => a.uid === user.uid)?.slots?.includes(key);
                                                const isFull = count >= sessionData.memberCount;
                                                const isActive = activeDetailSlot === key;
                                                
                                                let cellBg = 'transparent';
                                                if (isFull) {
                                                    cellBg = '#ef4444'; 
                                                } else if (count > 0) {
                                                    const ratio = count / sessionData.memberCount;
                                                    const opacity = 0.25 + (ratio * 0.7); 
                                                    cellBg = `rgba(67, 56, 202, ${opacity})`; 
                                                }

                                                return (
                                                    <div key={sIdx} onClick={() => handleSlotClick(ds, sIdx)}
                                                        style={{ backgroundColor: cellBg }}
                                                        className={`h-6 border-b border-slate-100 cursor-pointer relative slot-transition hover:opacity-80 
                                                            ${isMe ? 'ring-1 ring-inset ring-white/40 shadow-inner' : ''}
                                                            ${isActive ? 'ring-2 ring-indigo-500 z-10' : ''}`}>
                                                        {isMe && <div className="absolute inset-0 flex items-center justify-center opacity-40 pointer-events-none"><div className="w-1 h-1 bg-white rounded-full"></div></div>}
                                                        {count > 0 && <div className={`absolute inset-0 flex items-center justify-center text-[8px] font-black pointer-events-none ${isFull || count >= sessionData.memberCount/2 ? 'text-white' : 'text-indigo-900/40'}`}>{count}</div>}
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    </div>

                    {activeDetailSlot && (
                        <div className="fixed bottom-4 left-1/2 -translate-x-1/2 w-[90%] max-w-sm bg-white/95 backdrop-blur-md shadow-2xl rounded-3xl p-4 border border-slate-200 z-50 animate-slide-up text-left">
                            <div className="flex justify-between items-center mb-3 text-slate-900">
                                <div className="text-[10px] font-black text-indigo-600 uppercase tracking-widest flex items-center gap-1.5">
                                    <IconUsers /> {activeDetailSlot.split(':')[0].replace(/-/g, '/')} {8 + Math.floor(activeDetailSlot.split(':')[1] / 2)}:{activeDetailSlot.split(':')[1] % 2 === 0 ? '00' : '30'}
                                </div>
                                <button onClick={() => setActiveDetailSlot(null)} className="text-slate-400 p-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                                </button>
                            </div>
                            <div className="flex flex-wrap gap-2 max-h-32 overflow-y-auto no-scrollbar">
                                {activeParticipants.length > 0 ? activeParticipants.map((p) => (
                                    <div key={p.uid} className="flex items-center gap-1.5 bg-slate-50 px-2 py-1 rounded-full border border-slate-100">
                                        {p.photoURL ? <img src={p.photoURL} className="w-4 h-4 rounded-full shadow-sm" /> : <div className="w-4 h-4 bg-indigo-100 rounded-full flex items-center justify-center text-[8px] font-black text-indigo-600 uppercase">{p.name?.charAt(0) || '?'}</div>}
                                        <span className="text-[10px] font-bold text-slate-700">{p.name}</span>
                                    </div>
                                )) : <div className="text-center py-2 text-[10px] font-bold text-slate-400 w-full italic">まだ誰も選んでいません</div>}
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // --- Sub-Components ---

        function AuthGate({ onGoogle, onAnon }) {
            return (
                <div className="min-h-screen bg-indigo-600 flex items-center justify-center p-6 text-white text-center">
                    <div className="w-full max-w-sm bg-white text-slate-900 p-8 rounded-[2.5rem] shadow-2xl">
                        <div className="w-16 h-16 bg-indigo-600 rounded-2xl flex items-center justify-center shadow-xl mx-auto mb-6 text-white italic font-black text-2xl shadow-indigo-100">B</div>
                        <h1 className="text-3xl font-black mb-1 text-indigo-600 italic tracking-tighter leading-tight">BandSync</h1>
                        <p className="text-[10px] text-slate-400 font-bold mb-10 uppercase tracking-widest leading-relaxed text-center">練習日程をみんなで共有しよう</p>
                        <div className="space-y-4">
                            <button onClick={onGoogle} className="w-full py-5 bg-indigo-600 text-white rounded-2xl font-black flex items-center justify-center hover:bg-indigo-700 shadow-xl shadow-indigo-100 transition-all text-sm">
                                <IconGoogle /> Googleアカウントでログイン
                            </button>
                            <div className="py-2 flex items-center text-slate-300 text-[10px] font-bold uppercase tracking-widest before:flex-1 before:border-t before:mr-3 after:flex-1 after:border-t after:ml-3">または</div>
                            <button onClick={onAnon} className="w-full py-4 bg-slate-50 text-slate-500 rounded-2xl font-bold text-sm hover:bg-slate-100 transition-all">名前だけで始める（匿名）</button>
                        </div>
                    </div>
                </div>
            );
        }

        function Landing({ onCreate, user, onGoogleLogin, onLogout }) {
            const [name, setName] = useState('');
            const [num, setNum] = useState(4);
            const isAnon = user.isAnonymous;

            return (
                <div className="min-h-screen bg-indigo-600 flex items-center justify-center p-6 text-white">
                    <div className="w-full max-w-sm bg-white text-slate-900 p-8 rounded-[2.5rem] shadow-2xl">
                        {isAnon && (
                            <div className="mb-6 p-4 bg-amber-50 rounded-2xl border border-amber-100 text-center">
                                <p className="text-[10px] font-black text-amber-600 uppercase tracking-widest mb-2 leading-none text-center">ゲスト参加中</p>
                                <button onClick={onGoogleLogin} className="w-full py-2 bg-white border border-amber-200 text-amber-700 text-[10px] font-black rounded-lg hover:bg-amber-100 transition-all flex items-center justify-center">
                                    <IconGoogle /> Googleログインに切り替える
                                </button>
                            </div>
                        )}
                        <div className="flex items-center justify-between mb-8 border-b pb-6 text-left">
                            <div className="flex items-center gap-3">
                                {user.photoURL ? <img src={user.photoURL} className="w-10 h-10 rounded-full shadow-sm" /> : <div className="w-10 h-10 bg-indigo-100 rounded-full flex items-center justify-center text-indigo-600 font-black italic text-center">U</div>}
                                <div className="text-slate-900 text-left">
                                    <p className="text-[9px] font-bold text-slate-400 uppercase leading-none mb-1">{isAnon ? "GUEST" : "LOGGED IN"}</p>
                                    <p className="font-black text-sm truncate w-32">{user.displayName || "ゲストユーザー"}</p>
                                </div>
                            </div>
                            <button onClick={onLogout} className="text-slate-300 hover:text-rose-500 transition-colors p-2"><IconLogout /></button>
                        </div>
                        <div className="space-y-8 text-center text-slate-900">
                            <div>
                                <label className="text-[10px] font-black text-slate-400 block mb-2 uppercase tracking-widest text-center">プロジェクト名 / バンド名</label>
                                <input className="w-full p-4 bg-slate-50 border-none rounded-2xl font-black text-lg text-center focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="例: BABA-LIVE" value={name} onChange={e => setName(e.target.value)} />
                            </div>
                            <div>
                                <label className="text-[10px] font-black text-slate-400 block mb-2 uppercase tracking-widest text-center">目標人数</label>
                                <div className="flex items-center justify-between gap-4">
                                    <button onClick={() => setNum(Math.max(1, num - 1))} className="w-14 h-14 bg-slate-100 rounded-2xl text-xl font-black hover:bg-slate-200 transition-colors">-</button>
                                    <div className="text-center flex-1">
                                        <span className="text-4xl font-black tabular-nums">{num}</span>
                                        <span className="text-xs font-bold ml-1 text-slate-400 uppercase">人</span>
                                    </div>
                                    <button onClick={() => setNum(num + 1)} className="w-14 h-14 bg-slate-100 rounded-2xl text-xl font-black hover:bg-slate-200 transition-colors">+</button>
                                </div>
                            </div>
                            <button disabled={!name} onClick={() => onCreate(name, num)} className="w-full py-5 bg-indigo-600 text-white rounded-2xl font-black shadow-xl shadow-indigo-100 hover:bg-indigo-700 transition-all">調整カレンダーを作成</button>
                        </div>
                    </div>
                </div>
            );
        }

        function JoinView({ bandName, userName, setUserName, onJoin, user, onGoogleLogin, isJoining }) {
            const isAnon = user.isAnonymous;
            return (
                <div className="min-h-screen bg-indigo-600 flex items-center justify-center p-4 text-slate-900 text-left">
                    <div className="bg-white p-8 rounded-[2.5rem] shadow-2xl w-full max-w-sm text-center">
                        {isAnon && (
                            <div className="mb-6 p-4 bg-amber-50 rounded-2xl border border-amber-100 text-center">
                                <p className="text-[9px] font-black text-amber-600 uppercase tracking-widest mb-2 leading-none text-center">ゲスト参加中</p>
                                <button onClick={onGoogleLogin} className="w-full py-2 bg-white border border-amber-200 text-amber-700 text-[10px] font-black rounded-lg hover:bg-amber-100 transition-all flex items-center justify-center">
                                    <IconGoogle /> Googleでログインし直す
                                </button>
                            </div>
                        )}
                        <h1 className="text-xl font-black mb-2 text-indigo-600 italic">BandSync</h1>
                        <p className="text-sm font-bold mb-8 text-slate-400 uppercase tracking-widest leading-tight">{bandName}</p>
                        <input 
                            className="w-full p-4 bg-slate-50 border-none rounded-2xl font-black text-lg text-center focus:ring-2 focus:ring-indigo-500 outline-none mb-4" 
                            placeholder="あなたの表示名" 
                            value={userName || ''} 
                            onChange={e => setUserName(e.target.value)} 
                        />
                        <button 
                            onClick={onJoin} 
                            disabled={!userName || !userName.trim() || isJoining} 
                            className="w-full py-5 bg-indigo-600 text-white rounded-2xl font-black shadow-lg hover:bg-indigo-700 transition-all disabled:opacity-50 text-center"
                        >
                            {isJoining ? "処理中..." : "カレンダーを表示"}
                        </button>
                    </div>
                </div>
            );
        }

        function LoadingView() { return <div className="h-screen flex items-center justify-center font-black text-slate-300 animate-pulse italic uppercase tracking-tighter text-center">LOADING...</div>; }
        
        function ErrorView({ message, onRetry }) {
            return (
                <div className="min-h-screen flex items-center justify-center p-6 bg-rose-50 text-center text-slate-900">
                    <div className="bg-white p-8 rounded-3xl shadow-xl border border-rose-100 max-w-md w-full text-center">
                        <h1 className="text-xl font-black text-rose-600 mb-4 uppercase italic">ERROR</h1>
                        <p className="text-sm text-slate-600 mb-6 leading-relaxed text-center">{message}</p>
                        <button onClick={onRetry} className="w-full py-3 bg-rose-600 text-white rounded-xl font-bold uppercase hover:bg-rose-700 transition-all text-center">リトライ</button>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
