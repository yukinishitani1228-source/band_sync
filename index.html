<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>bandsync</title>
    <!-- Tailwind CSS & React libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Firebase SDK (Compat version) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        .no-callout { -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        input[type="date"] { color-scheme: light; background: #f8fafc; border: none; outline: none; }
        .full-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #f1f5f9; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            overflow-y: auto;
        }
        @keyframes soft-pulse {
            0% { transform: scale(1); box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.4); }
            50% { transform: scale(1.02); box-shadow: 0 20px 25px -5px rgba(79, 70, 229, 0.2); }
            100% { transform: scale(1); box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.4); }
        }
        .btn-prominent {
            animation: soft-pulse 3s infinite ease-in-out;
        }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- SVG Icons ---
        const Icons = {
            Plus: ({ size = 24, className = "" }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            ),
            Minus: ({ size = 24, className = "" }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            ),
            Trash: ({ size = 24, className = "" }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
            ),
            Edit: ({ size = 24, className = "" }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
            ),
            Key: ({ size = 24, className = "" }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    <circle cx="7.5" cy="15.5" r="5.5"></circle>
                    <path d="m21 2-9.6 9.6"></path>
                    <path d="m15.5 7.5 3 3L22 7l-3-3-3.5 3.5Z"></path>
                </svg>
            ),
            Clock: ({ size = 24, className = "" }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
            ),
            ChevronLeft: ({ size = 24, className = "" }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="15 18 9 12 15 6"></polyline></svg>
            ),
            ChevronRight: ({ size = 24, className = "" }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="9 18 15 12 9 6"></polyline></svg>
            ),
            LogOut: ({ size = 24, className = "" }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
            ),
            Share: ({ size = 24, className = "" }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>
            ),
            CheckCircle: ({ size = 24, className = "" }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
            ),
            Copy: ({ size = 24, className = "" }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            ),
            Paste: ({ size = 24, className = "" }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg>
            ),
            X: ({ size = 24, className = "" }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            ),
            ExternalLink: ({ size = 24, className = "" }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>
            ),
            Alert: ({ size = 24, className = "" }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
            ),
            User: ({ size = 24, className = "" }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
            ),
            Calendar: ({ size = 24, className = "" }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
            )
        };

        // --- Firebase Initialization ---
        const firebaseConfig = {
          apiKey: "AIzaSyDkvpOO9yyFovWzUo3SK42q_Rf5l_dF6UE",
          authDomain: "bandsync-faba8.firebaseapp.com",
          projectId: "bandsync-faba8",
          storageBucket: "bandsync-faba8.firebasestorage.app",
          messagingSenderId: "333666872919",
          appId: "1:333666872919:web:27f0f2d8b1deaa9175bd12"
        };
        
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = "bandsync-app-v1";

        // --- Utils ---
        const HOURS = Array.from({ length: 32 }, (_, i) => {
            let h = Math.floor(i / 2) + 8;
            const m = i % 2 === 0 ? '00' : '30';
            return `${h.toString().padStart(2, '0')}:${m}`;
        });
        const getNextTimeLabel = (idx) => (idx === HOURS.length - 1 ? "00:00" : HOURS[idx + 1]);
        const WEEKDAYS = ['日', '月', '火', '水', '木', '金', '土'];
        const getWeekdayIndex = (dateStr) => new Date(dateStr.replace(/-/g, '/')).getDay();
        const getDatesInRange = (start, end) => {
            const dates = []; if (!start || !end) return dates;
            let curr = new Date(start.replace(/-/g, '/'));
            const stop = new Date(end.replace(/-/g, '/'));
            while (curr <= stop) {
                const y = curr.getFullYear(), m = String(curr.getMonth() + 1).padStart(2, '0'), d = String(curr.getDate()).padStart(2, '0');
                dates.push(`${y}-${m}-${d}`); curr.setDate(curr.getDate() + 1);
            }
            return dates;
        };
        const safePushState = (id) => {
            try {
                const url = new URL(window.location.href);
                if (id) url.searchParams.set('cid', id); else url.searchParams.delete('cid');
                window.history.pushState({}, '', url.toString());
            } catch (e) {}
        };

        // --- View Components ---

        function Header({ user, onLogout, onBack }) {
            return (
                <header className="bg-white border-b sticky top-0 z-50 px-4 py-3 flex items-center justify-between shadow-sm shrink-0">
                    <div className="flex items-center gap-3">
                        {onBack && <button onClick={onBack} className="p-1.5 hover:bg-slate-100 rounded-full transition-colors"><Icons.ChevronLeft size={22} /></button>}
                        <button onClick={() => onBack ? onBack() : null} className="text-xl font-black bg-gradient-to-r from-indigo-600 to-blue-600 bg-clip-text text-transparent outline-none">bandsync</button>
                    </div>
                    <div className="flex items-center gap-2">
                        <div className="flex items-center gap-2 pl-2 ml-1">
                            {user.photoURL ? <img src={user.photoURL} alt="" className="w-8 h-8 rounded-full border border-slate-200 shadow-sm" /> : <div className="w-8 h-8 bg-slate-100 rounded-full flex items-center justify-center text-slate-400 font-bold text-[10px]">U</div>}
                            <button onClick={onLogout} className="p-2 hover:bg-red-50 text-slate-400 hover:text-red-500 rounded-full transition-colors"><Icons.LogOut size={20} /></button>
                        </div>
                    </div>
                </header>
            );
        }

        function AuthView({ onGoogle, onGuest }) {
            return (
                <div className="flex flex-col items-center justify-center h-screen p-6 text-center bg-white">
                    <div className="mb-10 animate-in fade-in zoom-in duration-700">
                        <div className="w-20 h-20 bg-indigo-600 rounded-[2.2rem] flex items-center justify-center mx-auto mb-6 shadow-2xl shadow-indigo-200"><Icons.Calendar size={40} className="text-white" /></div>
                        <h1 className="text-4xl font-black tracking-tighter mb-4 text-slate-800">bandsync</h1>
                        <p className="text-slate-500 max-w-xs mx-auto text-base font-medium leading-relaxed">バンドの予定調整を、<br/>もっとスマートに。</p>
                    </div>
                    <div className="flex flex-col gap-3.5 w-full max-w-xs">
                        <button onClick={onGoogle} className="bg-white border-2 border-slate-100 py-3.5 rounded-2xl font-bold hover:bg-slate-50 shadow-sm flex items-center justify-center gap-3 transition-all active:scale-95 text-slate-700">
                            <img src="https://www.google.com/favicon.ico" className="w-4 h-4" alt=""/> Googleでログイン
                        </button>
                        <button onClick={onGuest} className="bg-slate-800 text-white py-3.5 rounded-2xl font-bold hover:bg-slate-900 shadow-lg active:scale-95 transition-all">ゲストとして始める</button>
                    </div>
                </div>
            );
        }

        function Dashboard({ user, onSelect, onSettings, onCreate, onEdit }) {
            const [calendars, setCalendars] = useState([]);
            const [deleteTarget, setDeleteTarget] = useState(null);
            const [loading, setLoading] = useState(true);
            const [showStudioLinks, setShowStudioLinks] = useState(false);

            useEffect(() => {
                const path = `artifacts/${appId}/public/data/calendars`;
                const unsub = db.collection(path).onSnapshot(snap => {
                    setCalendars(snap.docs.map(doc => ({ id: doc.id, ...doc.data() })).filter(c => c.memberUids?.includes(user.uid) || c.creatorId === user.uid));
                    setLoading(false);
                });
                return () => unsub();
            }, [user.uid]);

            const owned = useMemo(() => calendars.filter(c => c.creatorId === user.uid), [calendars, user.uid]);
            const joined = useMemo(() => calendars.filter(c => c.creatorId !== user.uid), [calendars, user.uid]);

            const handleDeleteConfirm = async () => {
                if (!deleteTarget) return;
                const calId = deleteTarget.id, isOwner = deleteTarget.creatorId === user.uid, path = `artifacts/${appId}/public/data/calendars`;
                setDeleteTarget(null);
                try {
                    if (isOwner) await db.collection(path).doc(calId).delete();
                    else await db.collection(path).doc(calId).update({ 
                        memberUids: firebase.firestore.FieldValue.arrayRemove(user.uid),
                        [`memberData.${user.uid}`]: firebase.firestore.FieldValue.delete()
                    });
                } catch (err) { console.error(err); }
            };

            const CalendarItem = ({ c }) => (
                <div onClick={() => onSelect(c.id)} className="bg-white p-5 rounded-[2rem] border border-slate-100 shadow-sm hover:shadow-xl hover:-translate-y-0.5 transition-all cursor-pointer flex items-center justify-between group">
                    <div className="overflow-hidden">
                        <h3 className="font-black text-base truncate text-slate-800 mb-1">{c.name}</h3>
                        <p className="text-[10px] text-slate-400 font-bold flex items-center gap-1"><Icons.Clock size={12}/> {c.startDate.replace(/-/g, '/')} - {c.endDate.replace(/-/g, '/')}</p>
                    </div>
                    <div className="flex items-center gap-2 shrink-0">
                        <div className="bg-indigo-50 text-indigo-500 text-[9px] font-black px-2.5 py-1 rounded-full">{c.totalMembers}名</div>
                        {c.creatorId === user.uid && <button onClick={(e) => { e.stopPropagation(); onEdit(c); }} className="p-2 text-slate-500 hover:text-indigo-600 hover:bg-indigo-50 rounded-full transition-all"><Icons.Edit size={16}/></button>}
                        <button onClick={(e) => { e.stopPropagation(); setDeleteTarget(c); }} className="p-2 text-slate-500 hover:text-red-600 hover:bg-red-50 rounded-full transition-all"><Icons.Trash size={18}/></button>
                    </div>
                </div>
            );

            return (
                <div className="space-y-6 flex flex-col h-full overflow-hidden">
                    <div className="flex items-center justify-between shrink-0 px-2">
                        <h2 className="text-xl font-black text-slate-800 tracking-tight">マイカレンダー</h2>
                        <div className="flex items-center gap-3">
                            <button onClick={onSettings} className="p-2 hover:bg-slate-100 rounded-full transition-colors text-slate-600" title="基本設定">
                                <Icons.Key size={22} />
                            </button>
                            <button onClick={() => setShowStudioLinks(true)} className="bg-white border border-slate-200 py-1.5 px-4 rounded-full font-black text-xs text-indigo-600 shadow-sm active:scale-95 transition-all">スタ</button>
                            <button onClick={onCreate} className="bg-gradient-to-r from-indigo-600 to-blue-600 text-white py-2 px-5 rounded-full font-black shadow-xl shadow-indigo-100 hover:shadow-indigo-200 hover:-translate-y-0.5 active:scale-95 text-sm flex items-center gap-2 transition-all btn-prominent">
                                <Icons.Plus size={20}/> 
                                <span className="tracking-tight">作成する</span>
                            </button>
                        </div>
                    </div>
                    <div className="flex-1 overflow-y-auto custom-scrollbar px-1 space-y-8 pb-10">
                        {loading ? <div className="py-20 text-center text-slate-300 font-bold">読込中...</div> : calendars.length === 0 ? <div className="py-20 border-2 border-dashed border-slate-200 rounded-[2.5rem] bg-white text-center text-slate-300 font-black flex flex-col items-center gap-3"><Icons.Calendar size={48} className="opacity-10" /><p className="text-sm">カレンダーがまだありません</p></div> : (
                            <>
                                {owned.length > 0 && <section className="space-y-3"><div className="flex items-center gap-2 ml-2"><div className="w-1.5 h-4 bg-indigo-500 rounded-full"></div><h3 className="text-xs font-black text-slate-400 uppercase tracking-widest">主催カレンダー</h3></div><div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">{owned.map(c => <CalendarItem key={c.id} c={c} />)}</div></section>}
                                {joined.length > 0 && <section className="space-y-3"><div className="flex items-center gap-2 ml-2"><div className="w-1.5 h-4 bg-blue-400 rounded-full"></div><h3 className="text-xs font-black text-slate-400 uppercase tracking-widest">参加カレンダー</h3></div><div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">{joined.map(c => <CalendarItem key={c.id} c={c} />)}</div></section>}
                            </>
                        )}
                    </div>
                    {showStudioLinks && (
                        <div className="fixed inset-0 z-[150] bg-slate-900/40 backdrop-blur-md flex items-center justify-center p-4" onClick={() => setShowStudioLinks(false)}>
                            <div className="bg-white w-full max-w-sm rounded-[3rem] p-8 shadow-2xl space-y-6 animate-in zoom-in-95" onClick={e => e.stopPropagation()}>
                                <div className="flex items-center justify-between"><h3 className="text-2xl font-black text-slate-800 text-center flex-1">スタジオ予約</h3><button onClick={() => setShowStudioLinks(false)} className="p-2 hover:bg-slate-50 rounded-full transition-colors"><Icons.X size={20}/></button></div>
                                <div className="flex flex-col gap-3">
                                    <a href="http://www.gw-studio.com/studios/studio_baba3rd/index" target="_blank" rel="noopener noreferrer" className="flex items-center justify-between bg-slate-50 p-5 rounded-2xl border border-slate-100 font-black text-slate-700 hover:bg-indigo-50 transition-all"><span>ゲートウェイ</span><Icons.ExternalLink size={18} /></a>
                                    <a href="https://bazookastudio.com/" target="_blank" rel="noopener noreferrer" className="flex items-center justify-between bg-slate-50 p-5 rounded-2xl border border-slate-100 font-black text-slate-700 hover:bg-indigo-50 transition-all"><span>バズーカ</span><Icons.ExternalLink size={18} /></a>
                                    <a href="https://www.bassontop.co.jp/band/takadanobaba/" target="_blank" rel="noopener noreferrer" className="flex items-center justify-between bg-slate-50 p-5 rounded-2xl border border-slate-100 font-black text-slate-700 hover:bg-indigo-50 transition-all"><span>ベースオントップ</span><Icons.ExternalLink size={18} /></a>
                                </div>
                                <button onClick={() => setShowStudioLinks(false)} className="w-full py-4 bg-slate-800 text-white font-black rounded-2xl shadow-xl text-sm">閉じる</button>
                            </div>
                        </div>
                    )}
                    {deleteTarget && (
                        <div className="fixed inset-0 z-[1100] bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4">
                            <div className="bg-white w-full max-w-sm rounded-[2.2rem] p-8 text-center animate-in zoom-in-95 shadow-2xl">
                                <div className="w-14 h-14 bg-red-50 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4"><Icons.Alert size={28}/></div>
                                <h3 className="text-lg font-black text-slate-800 mb-2">削除しますか？</h3>
                                <p className="text-slate-500 text-xs mb-6 font-medium leading-relaxed">{deleteTarget.creatorId === user.uid ? "このカレンダーは完全に消去されます。" : "自分の一覧からこのカレンダーを消去します。"}</p>
                                <div className="flex gap-3"><button onClick={() => setDeleteTarget(null)} className="flex-1 py-3.5 font-bold text-slate-400 rounded-2xl bg-slate-50">やめる</button><button onClick={handleDeleteConfirm} className="flex-1 bg-red-500 text-white py-3.5 rounded-2xl font-black shadow-lg shadow-red-100 active:scale-95 transition-all">削除</button></div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        function SettingsView({ user, onBack }) {
            const [weeklySlots, setWeeklySlots] = useState({});
            const [enabled, setEnabled] = useState(true);
            const [loading, setLoading] = useState(true);
            const [selection, setSelection] = useState(null);

            useEffect(() => {
                const unsub = db.doc(`artifacts/${appId}/public/data/userDefaults/${user.uid}`).onSnapshot(snap => {
                    if (snap.exists) { 
                        const data = snap.data();
                        setWeeklySlots(data.slots || {});
                        setEnabled(data.enabled !== false);
                    }
                    setLoading(false);
                });
                return () => unsub();
            }, [user.uid]);

            const handleSave = async () => {
                const normalizedSlots = {};
                Object.keys(weeklySlots).forEach(key => normalizedSlots[String(key)] = weeklySlots[key]);
                await db.doc(`artifacts/${appId}/public/data/userDefaults/${user.uid}`).set({ slots: normalizedSlots, enabled, updatedAt: Date.now(), uid: user.uid });
                onBack();
            };

            const toggleRange = (dayIdx, hIdx) => {
                const dayKey = String(dayIdx);
                const curr = weeklySlots[dayKey] || [];
                if (!selection) {
                    setSelection({ dayIdx, startIdx: hIdx, currentIdx: hIdx });
                } else {
                    if (selection.dayIdx !== dayIdx) {
                        setSelection({ dayIdx, startIdx: hIdx, currentIdx: hIdx });
                        return;
                    }
                    const start = Math.min(selection.startIdx, hIdx), end = Math.max(selection.startIdx, hIdx);
                    const rangeTimes = HOURS.slice(start, end + 1);
                    const allSelected = rangeTimes.every(t => curr.includes(t));
                    const nextSlots = allSelected ? curr.filter(t => !rangeTimes.includes(t)) : Array.from(new Set([...curr, ...rangeTimes]));
                    setWeeklySlots({ ...weeklySlots, [dayKey]: nextSlots });
                    setSelection(null);
                }
            };

            return (
                <div className="space-y-4 flex flex-col h-full overflow-hidden animate-in slide-in-from-right duration-300 px-1 pb-4">
                    <div className="bg-indigo-600 p-5 rounded-[2.2rem] text-white shadow-xl flex items-center justify-between shrink-0">
                        <div className="flex items-center gap-3">
                            <Icons.Key size={24} />
                            <div><h2 className="text-base font-black tracking-tight leading-tight">基本スケジュール設定</h2><p className="text-[10px] opacity-70 font-bold uppercase tracking-wider">Default Availability</p></div>
                        </div>
                        <button onClick={handleSave} className="bg-white text-indigo-600 px-6 py-2.5 rounded-full font-black text-sm shadow-md active:scale-95 transition-all">保存</button>
                    </div>
                    <div className="flex items-center justify-between bg-white p-4 rounded-2xl border border-slate-100 shrink-0 mx-1 shadow-sm"><span className="text-sm font-black text-slate-700">カレンダーへの自動反映</span><button onClick={() => setEnabled(!enabled)} className={`w-12 h-6 rounded-full transition-colors relative shadow-inner ${enabled ? 'bg-indigo-600' : 'bg-slate-200'}`}><div className={`absolute top-1 w-4 h-4 bg-white rounded-full shadow-md transition-all ${enabled ? 'left-7' : 'left-1'}`}></div></button></div>
                    {/* 23:30が見切れないよう rounded-none (長方形) に修正 */}
                    <div className="bg-white rounded-none shadow-xl overflow-hidden flex-1 border border-slate-100 relative mx-1">
                        <div className="overflow-x-auto h-full custom-scrollbar">
                            <div className="w-full grid grid-cols-[45px_repeat(7,1fr)] bg-slate-200 gap-px">
                                {/* タイムラベル列 */}
                                <div className="flex flex-col gap-px">
                                    <div className="h-12 bg-white flex items-center justify-center"></div>
                                    {HOURS.map((h, i) => (
                                        <div key={h} className="h-8 bg-white flex items-center justify-center">
                                            <span className={`text-[10px] text-slate-300 font-mono font-bold ${i % 2 === 0 ? '' : 'hidden'}`}>{h}</span>
                                        </div>
                                    ))}
                                </div>
                                {/* 曜日列 */}
                                {WEEKDAYS.map((day, idx) => (
                                    <div key={idx} className="flex flex-col gap-px">
                                        <div className="h-12 flex items-center justify-center font-black text-slate-500 bg-white text-[10px]">{day}</div>
                                        {HOURS.map((h, hi) => {
                                            const isActive = (weeklySlots[String(idx)] || []).includes(h);
                                            const isPreview = selection && selection.dayIdx === idx && ((hi >= selection.startIdx && hi <= selection.currentIdx) || (hi <= selection.startIdx && hi >= selection.currentIdx));
                                            return (
                                                <div key={h} onClick={() => toggleRange(idx, hi)} onMouseEnter={() => selection && setSelection({ ...selection, currentIdx: hi })} className={`h-8 relative transition-all cursor-pointer ${isActive ? 'bg-indigo-400' : 'bg-white hover:bg-slate-50'}`}>
                                                    {isPreview && <div className="absolute inset-0 bg-indigo-600/30 border border-indigo-600 z-10"></div>}
                                                </div>
                                            );
                                        })}
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function CalendarView({ user, calendarId, onNotFound, clipboard, setClipboard }) {
            const [calendar, setCalendar] = useState(null), [overrides, setOverrides] = useState({}), [allDefaults, setAllDefaults] = useState({}), [page, setPage] = useState(0), [selection, setSelection] = useState(null), [infoPopup, setInfoPopup] = useState(null), [showPerfectSlots, setShowPerfectSlots] = useState(false), [showStudioLinks, setShowStudioLinks] = useState(false), [toast, setToast] = useState(null);
            const timerRef = useRef(null), isLongPressed = useRef(false), showToast = (msg) => { setToast(msg); setTimeout(() => setToast(null), 2500); };

            useEffect(() => {
                const path = `artifacts/${appId}/public/data/calendars/${calendarId}`;
                db.doc(path).get().then(snap => {
                    if (snap.exists) {
                        db.doc(path).update({ 
                            memberUids: firebase.firestore.FieldValue.arrayUnion(user.uid), 
                            [`memberData.${user.uid}`]: { displayName: user.displayName || 'ユーザー', photoURL: user.photoURL || null } 
                        });
                    } else onNotFound();
                });
                const unsubCal = db.doc(path).onSnapshot(snap => snap.exists ? setCalendar(snap.data()) : onNotFound());
                const unsubAvail = db.collection(`artifacts/${appId}/public/data/calendarAvailability`).onSnapshot(snap => {
                    const data = {}; snap.docs.forEach(d => { if (d.id.startsWith(calendarId)) data[d.id.split('_').slice(1).join('_')] = d.data().slots || {}; });
                    setOverrides(data);
                });
                const unsubDefaults = db.collection(`artifacts/${appId}/public/data/userDefaults`).onSnapshot(snap => {
                    const data = {}; snap.docs.forEach(d => data[d.id] = d.data() || {}); setAllDefaults(data);
                });
                return () => { unsubCal(); unsubAvail(); unsubDefaults(); };
            }, [calendarId, user.uid]);

            const dates = useMemo(() => calendar ? getDatesInRange(calendar.startDate, calendar.endDate) : [], [calendar]);
            const pagedDates = useMemo(() => dates.slice(page * 7, (page * 7) + 7), [dates, page]);
            const getAvail = (uid, dateStr) => {
                const userOverrides = overrides[uid] || {}, defaultObj = allDefaults[uid] || {}, day = getWeekdayIndex(dateStr);
                return userOverrides[dateStr] !== undefined ? userOverrides[dateStr] : (defaultObj.enabled === false ? [] : (defaultObj.slots || {})[String(day)] || []);
            };
            const getSlotStatus = (date, h) => {
                let count = 0, users = []; if (!calendar) return { count, users };
                (calendar.memberUids || []).forEach(uid => { if (getAvail(uid, date).includes(h)) { count++; users.push(uid); } });
                return { count, users };
            };
            const getSlotColor = (count) => count === 0 ? 'bg-white' : (calendar && count >= calendar.totalMembers ? 'bg-red-400 shadow-sm' : ['bg-indigo-200', 'bg-indigo-300', 'bg-indigo-400', 'bg-indigo-500', 'bg-indigo-600', 'bg-indigo-700', 'bg-indigo-800'][Math.min(count - 1, 6)]);
            
            const toggle = async (date, hi) => {
                if (isLongPressed.current) return;
                if (!selection) setSelection({ date, startIdx: hi, currentIdx: hi });
                else {
                    if (selection.date !== date) { setSelection({ date, startIdx: hi, currentIdx: hi }); return; }
                    const start = Math.min(selection.startIdx, hi), end = Math.max(selection.startIdx, hi), times = HOURS.slice(start, end + 1), curr = getAvail(user.uid, selection.date);
                    const up = times.every(t => curr.includes(t)) ? curr.filter(t => !times.includes(t)) : Array.from(new Set([...curr, ...times]));
                    await db.doc(`artifacts/${appId}/public/data/calendarAvailability/${calendarId}_${user.uid}`).set({ slots: { ...(overrides[user.uid] || {}), [selection.date]: up }, updatedAt: Date.now() });
                    setSelection(null);
                }
            };
            const handleLStart = (e, users) => {
                isLongPressed.current = false;
                const rect = e.currentTarget.getBoundingClientRect();
                timerRef.current = setTimeout(() => {
                    setInfoPopup({ x: rect.left + window.scrollX, y: rect.top + window.scrollY, users });
                    isLongPressed.current = true;
                }, 500);
            };
            const handleLEnd = (e) => {
                clearTimeout(timerRef.current);
                if (isLongPressed.current) {
                    if (e.cancelable) e.preventDefault();
                    setTimeout(() => setInfoPopup(null), 1000); 
                    setTimeout(() => { isLongPressed.current = false; }, 300);
                }
            };
            const perfectRanges = useMemo(() => {
                if (!calendar) return [];
                const ranges = [];
                dates.forEach(date => {
                    const idxs = []; HOURS.forEach((h, i) => { if (getSlotStatus(date, h).count >= (calendar.totalMembers || 1)) idxs.push(i); });
                    if (idxs.length > 0) {
                        idxs.sort((a,b)=>a-b); let s = idxs[0];
                        for (let i=0; i<idxs.length; i++) { if (idxs[i+1] !== idxs[i]+1) { ranges.push({ date: date.split('-').slice(1).join('/'), display: `${HOURS[s]}〜${getNextTimeLabel(idxs[i])}` }); if (i+1 < idxs.length) s = idxs[i+1]; } }
                    }
                });
                return ranges;
            }, [dates, overrides, allDefaults, calendar]);

            if (!calendar) return <div className="flex-1 flex items-center justify-center h-full"><div className="animate-spin rounded-full h-10 w-10 border-b-2 border-indigo-600"></div></div>;

            return (
                <div className="flex flex-col h-full gap-3 overflow-hidden animate-in fade-in duration-500 no-callout px-1">
                    <div className="flex items-center justify-between shrink-0">
                        <div><h2 className="text-xl font-black truncate max-w-[150px] text-slate-800 leading-tight">{calendar.name}</h2><p className="text-[11px] text-slate-400 font-bold tracking-tight uppercase">{calendar.startDate} - {calendar.endDate} ({calendar.totalMembers}名)</p></div>
                        <div className="flex items-center gap-1.5">
                            <button onClick={() => { setClipboard(overrides[user.uid] || {}); showToast("スケジュールをコピーしました"); }} className="p-2.5 bg-white border border-slate-200 rounded-xl shadow-sm active:scale-90 text-slate-500"><Icons.Copy size={18}/></button>
                            {clipboard && <button onClick={async () => { const up = { ...(overrides[user.uid] || {}) }; let c = 0; Object.keys(clipboard).forEach(d => { if (dates.includes(d)) { up[d] = clipboard[d]; c++; } }); if (c > 0) { await db.doc(`artifacts/${appId}/public/data/calendarAvailability/${calendarId}_${user.uid}`).set({ slots: up, updatedAt: Date.now() }); showToast(`${c}日分を貼り付けました`); } }} className="p-2.5 bg-indigo-50 border border-indigo-100 rounded-xl shadow-sm active:scale-90 text-indigo-600 animate-in zoom-in"><Icons.Paste size={18}/></button>}
                            <button onClick={() => { const u = new URL(window.location.href); u.searchParams.set('cid', calendarId); navigator.clipboard.writeText(u.toString()); showToast("共有リンクをコピーしました！"); }} className="p-3 bg-white border border-slate-200 rounded-xl shadow-sm active:scale-90 transition-all"><Icons.Share size={20} className="text-slate-600"/></button>
                            <button onClick={() => setShowStudioLinks(true)} className="w-12 h-12 rounded-2xl flex items-center justify-center bg-white border border-slate-200 shadow-sm active:scale-95 text-indigo-600 font-black text-sm">スタ</button>
                            <button onClick={() => setShowPerfectSlots(!showPerfectSlots)} className={`w-12 h-12 rounded-2xl flex items-center justify-center shadow-lg transition-all active:scale-95 ${perfectRanges.length > 0 ? 'bg-green-500 text-white animate-pulse' : 'bg-slate-200 text-slate-400'}`}><Icons.CheckCircle size={28}/></button>
                        </div>
                    </div>
                    {toast && <div className="fixed bottom-24 left-1/2 -translate-x-1/2 z-[300] bg-slate-800 text-white px-6 py-3 rounded-full font-black text-sm shadow-2xl animate-in fade-in slide-in-from-bottom-4 flex items-center gap-2 border border-slate-700"><Icons.CheckCircle size={16} className="text-green-400"/>{toast}</div>}
                    <div className="flex items-center justify-between bg-white p-1 rounded-2xl shadow-sm border border-slate-100 shrink-0"><button disabled={page === 0} onClick={() => setPage(p => p - 1)} className="p-2 disabled:opacity-20 hover:bg-slate-50 transition-all"><Icons.ChevronLeft size={24}/></button><span className="text-[11px] font-black text-slate-500 uppercase tracking-widest">{page + 1} / {Math.ceil(dates.length / 7)} PAGE</span><button disabled={(page + 1) * 7 >= dates.length} onClick={() => setPage(p => p + 1)} className="p-2 disabled:opacity-20 hover:bg-slate-50 transition-all"><Icons.ChevronRight size={24}/></button></div>
                    {/* 23:30が見切れないよう rounded-none (長方形) に修正 */}
                    <div className="bg-slate-100 rounded-none shadow-xl overflow-hidden flex-1 border border-slate-100 relative">
                        <div className="grid grid-cols-[50px_repeat(7,1fr)] bg-slate-100 gap-[1px] border-b sticky top-0 z-20 shrink-0"><div className="h-10 flex items-center justify-center text-[8px] font-black text-slate-400 bg-white tracking-widest uppercase">Time</div>{pagedDates.map(d => (<div key={d} className="h-10 flex flex-col items-center justify-center bg-white"><span className="text-[8px] font-black text-indigo-500 uppercase">{WEEKDAYS[getWeekdayIndex(d)]}</span><span className="text-base font-black text-slate-700">{d.split('-')[2]}</span></div>))}</div>
                        <div className="grid grid-cols-[50px_repeat(7,1fr)] bg-slate-100 gap-[1px] overflow-y-auto flex-1 custom-scrollbar"><div className="flex flex-col gap-[1px]">{HOURS.map((h, i) => (<div key={h} className={`h-8 flex items-center justify-center text-[10px] text-slate-300 font-mono font-bold bg-white rounded-[2px] mx-[2px] my-[1px] ${i % 2 === 0 ? '' : 'text-transparent'}`}>{h}</div>))}</div>{pagedDates.map(date => (
                            <div key={date} className="flex flex-col gap-[1px]">{HOURS.map((h, hi) => { 
                                const { count, users } = getSlotStatus(date, h), shade = count > 0 ? getSlotColor(count) : '', isSel = selection && selection.date === date && ((hi >= selection.startIdx && hi <= selection.currentIdx) || (hi <= selection.startIdx && hi >= selection.currentIdx)); 
                                return (<div key={h} 
                                            onClick={() => toggle(date, hi)} 
                                            onMouseEnter={() => selection && selection.date === date && setSelection({...selection, currentIdx: hi})} 
                                            onMouseDown={e => handleLStart(e, users)} 
                                            onTouchStart={e => handleLStart(e, users)} 
                                            onMouseUp={handleLEnd} 
                                            onTouchEnd={handleLEnd} 
                                            onMouseLeave={handleLEnd} 
                                            onContextMenu={e => e.preventDefault()}
                                            className={`h-8 bg-white cursor-pointer relative rounded-[2px] mx-[2px] my-[1px] ${shade}`}>
                                                {count > 0 && <div className="absolute inset-0 flex items-center justify-center text-[10px] font-black text-white pointer-events-none">{count}</div>}
                                                {isSel && <div className="absolute inset-0 bg-indigo-500/30 border border-indigo-600 z-10 rounded-[2px]"></div>}
                                        </div>); 
                            })}</div>
                        ))}</div>
                    </div>
                    {showStudioLinks && <div className="fixed inset-0 z-[150] bg-slate-900/40 backdrop-blur-md flex items-center justify-center p-4" onClick={() => setShowStudioLinks(false)}><div className="bg-white w-full max-w-sm rounded-[3rem] p-8 shadow-2xl space-y-6 animate-in zoom-in-95" onClick={e => e.stopPropagation()}><div className="flex items-center justify-between"><h3 className="text-2xl font-black text-slate-800 text-center flex-1">スタジオ予約</h3><button onClick={() => setShowStudioLinks(false)} className="p-2 hover:bg-slate-50 rounded-full transition-colors"><Icons.X size={20}/></button></div><div className="flex flex-col gap-3"><a href="http://www.gw-studio.com/studios/studio_baba3rd/index" target="_blank" rel="noopener noreferrer" className="flex items-center justify-between bg-slate-50 p-5 rounded-2xl border border-slate-100 font-black text-slate-700 hover:bg-indigo-50 transition-all"><span>ゲートウェイ</span><Icons.ExternalLink size={18} /></a><a href="https://bazookastudio.com/" target="_blank" rel="noopener noreferrer" className="flex items-center justify-between bg-slate-50 p-5 rounded-2xl border border-slate-100 font-black text-slate-700 hover:bg-indigo-50 transition-all"><span>バズーカ</span><Icons.ExternalLink size={18} /></a><a href="https://www.bassontop.co.jp/band/takadanobaba/" target="_blank" rel="noopener noreferrer" className="flex items-center justify-between bg-slate-50 p-5 rounded-2xl border border-slate-100 font-black text-slate-700 hover:bg-indigo-50 transition-all"><span>ベースオントップ</span><Icons.ExternalLink size={18} /></a></div><button onClick={() => setShowStudioLinks(false)} className="w-full py-4 bg-slate-800 text-white font-black rounded-2xl shadow-xl text-sm">閉じる</button></div></div>}
                    {infoPopup && <div className="fixed z-[300] bg-white p-4 rounded-[2rem] shadow-2xl border pointer-events-none animate-in fade-in zoom-in duration-200" style={{ top: Math.max(10, infoPopup.y - 120), left: Math.min(window.innerWidth - 180, Math.max(10, infoPopup.x - 70)) }}><p className="text-[9px] font-black text-slate-400 mb-3 uppercase text-center tracking-widest">参加者</p><div className="flex flex-col gap-3 min-w-[140px]">{infoPopup.users.length === 0 ? <span className="text-xs text-slate-300 text-center">なし</span> : infoPopup.users.map(uid => (
                                    <div key={uid} className="flex items-center gap-3">
                                        <div className="w-8 h-8 bg-indigo-50 rounded-full flex items-center justify-center overflow-hidden border border-indigo-100">
                                            {calendar.memberData?.[uid]?.photoURL ? <img src={calendar.memberData[uid].photoURL} className="w-full h-full object-cover" /> : <Icons.User size={14} className="text-indigo-400" />}
                                        </div>
                                        <span className="text-sm font-black text-slate-700 truncate">{calendar.memberData?.[uid]?.displayName || '不明'}</span>
                                    </div>
                                ))}</div></div>}
                    {showPerfectSlots && <div className="fixed inset-0 z-[150] modal-backdrop flex items-center justify-center p-4" onClick={() => setShowPerfectSlots(false)}><div className="bg-white w-full max-w-sm rounded-[3rem] p-8 shadow-2xl space-y-5 animate-in zoom-in-95" onClick={e => e.stopPropagation()}><div className="flex items-center justify-between"><h3 className="text-2xl font-black text-slate-800 text-center flex-1">全員揃う時間</h3><button onClick={() => setShowPerfectSlots(false)} className="p-2 hover:bg-slate-50 rounded-full transition-colors"><Icons.X size={20}/></button></div><div className="max-h-80 overflow-y-auto space-y-3 pr-2 custom-scrollbar">{perfectRanges.length === 0 ? <div className="text-center py-12 text-slate-300 font-bold">候補がありません</div> : perfectRanges.map((pr, i) => (<div key={i} className="flex items-center justify-between bg-green-50 p-4 rounded-2xl text-green-700 border border-green-100 font-black"><span>{pr.date}</span><span className="bg-white px-4 py-1.5 rounded-xl text-green-600 shadow-sm font-mono text-sm">{pr.display}</span></div>))}</div><button onClick={() => setShowPerfectSlots(false)} className="w-full py-4 bg-slate-800 text-white font-black rounded-2xl shadow-xl active:scale-95 transition-all text-sm uppercase tracking-widest">閉じる</button></div></div>}
                </div>
            );
        }

        function App() {
            const [user, setUser] = useState(null), [view, setView] = useState('loading'), [currentCalendarId, setCurrentCalendarId] = useState(null), [editingCalendar, setEditingCalendar] = useState(null), [hasChosenSession, setHasChosenSession] = useState(false), [clipboard, setClipboard] = useState(null);

            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged((u) => {
                    setUser(u); 
                    const params = new URLSearchParams(window.location.search);
                    const cid = params.get('cid');
                    if (!u) setView('auth');
                    else {
                        if (!u.isAnonymous || hasChosenSession || cid) {
                            if (cid) { setCurrentCalendarId(cid); setView('calendar'); } 
                            else { setView('dashboard'); }
                        } else setView('auth');
                    }
                });
                return () => unsubscribe();
            }, [hasChosenSession]);

            const handleModalSubmit = async (e) => {
                e.preventDefault(); const path = `artifacts/${appId}/public/data/calendars`;
                try {
                    if (editingCalendar.id) await db.collection(path).doc(editingCalendar.id).update({ name: editingCalendar.name, startDate: editingCalendar.start, endDate: editingCalendar.end, totalMembers: parseInt(editingCalendar.members) });
                    else {
                        const calId = crypto.randomUUID();
                        await db.collection(path).doc(calId).set({ 
                            name: editingCalendar.name, startDate: editingCalendar.start, endDate: editingCalendar.end, totalMembers: parseInt(editingCalendar.members), 
                            creatorId: user.uid, memberUids: [user.uid], 
                            memberData: { [user.uid]: { displayName: user.displayName || 'ユーザー', photoURL: user.photoURL || null } }, 
                            createdAt: Date.now() 
                        });
                        setCurrentCalendarId(calId); setView('calendar');
                        safePushState(calId);
                    }
                    setEditingCalendar(null);
                } catch (err) { console.error(err); }
            };

            if (view === 'loading') return <div className="flex items-center justify-center h-screen bg-slate-50"><div className="animate-spin rounded-full h-10 w-10 border-b-2 border-indigo-600"></div></div>;

            return (
                <div className="min-h-screen bg-slate-50 text-slate-900 flex flex-col overflow-hidden">
                    {view === 'auth' ? (
                        <AuthView onGoogle={async () => { await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); setHasChosenSession(true); }} onGuest={async () => { await auth.signInAnonymously(); setHasChosenSession(true); }} />
                    ) : user ? (
                        <>
                            {!editingCalendar && (
                                <Header user={user} onLogout={() => { auth.signOut(); setHasChosenSession(false); setView('auth'); }} onBack={view === 'settings' ? () => setView(currentCalendarId ? 'calendar' : 'dashboard') : view !== 'dashboard' ? () => { setCurrentCalendarId(null); setView('dashboard'); safePushState(null); } : null} />
                            )}
                            <main className="flex-1 max-w-6xl mx-auto w-full p-2 md:p-4 overflow-hidden flex flex-col relative">
                                {view === 'dashboard' && (<Dashboard user={user} onSelect={(id) => { setCurrentCalendarId(id); setView('calendar'); safePushState(id); }} onSettings={() => setView('settings')} onCreate={() => setEditingCalendar({ id: null, name: '', start: '2026-01-26', end: '2026-02-09', members: 4 })} onEdit={(c) => setEditingCalendar({ id: c.id, name: c.name, start: c.startDate, end: c.endDate, members: c.totalMembers })} />)}
                                {view === 'calendar' && currentCalendarId && (<CalendarView user={user} calendarId={currentCalendarId} onNotFound={() => { setView('dashboard'); setCurrentCalendarId(null); }} clipboard={clipboard} setClipboard={setClipboard} />)}
                                {view === 'settings' && <SettingsView user={user} onBack={() => setView(currentCalendarId ? 'calendar' : 'dashboard')} />}
                            </main>
                            {editingCalendar && (
                                <div className="full-backdrop"><form onSubmit={handleModalSubmit} className="bg-slate-100 w-full max-w-[340px] rounded-[2.5rem] shadow-2xl overflow-hidden animate-in zoom-in-95"><div className="w-full py-6 text-center"><h3 className="text-2xl font-black text-indigo-600 italic">{editingCalendar.id ? "カレンダーの編集" : "新しいカレンダー"}</h3></div><div className="px-6 pb-8 space-y-4"><div className="space-y-1"><label className="text-[11px] font-black text-slate-400 ml-1 uppercase">プロジェクト名</label><input required className="w-full bg-white rounded-[1.5rem] p-4 font-black text-xl text-center shadow-sm" value={editingCalendar.name} onChange={e => setEditingCalendar({...editingCalendar, name: e.target.value})} /></div><div className="grid grid-cols-2 gap-3"><div className="text-center space-y-1"><label className="text-[11px] font-black text-slate-400 uppercase">開始日</label><div className="bg-white rounded-full p-2 shadow-sm"><input required type="date" className="bg-transparent text-[13px] text-center w-full" value={editingCalendar.start} onChange={e => setEditingCalendar({...editingCalendar, start: e.target.value})} /></div></div><div className="text-center space-y-1"><label className="text-[11px] font-black text-slate-400 uppercase">終了日</label><div className="bg-white rounded-full p-2 shadow-sm"><input required type="date" className="bg-transparent text-[13px] text-center w-full" value={editingCalendar.end} onChange={e => setEditingCalendar({...editingCalendar, end: e.target.value})} /></div></div></div><div className="flex flex-col items-center space-y-2"><label className="text-[11px] font-black text-slate-400 uppercase">人数</label><div className="flex items-center gap-5"><button type="button" onClick={() => setEditingCalendar(p => ({...p, members: Math.max(1, p.members-1)}))} className="w-10 h-10 rounded-full bg-white flex items-center justify-center shadow-sm"><Icons.Minus size={20} /></button><div className="flex items-baseline"><span className="text-4xl font-black">{editingCalendar.members}</span><span className="text-xs ml-1">人</span></div><button type="button" onClick={() => setEditingCalendar(p => ({...p, members: Math.min(30, p.members+1)}))} className="w-10 h-10 rounded-full bg-white flex items-center justify-center shadow-sm"><Icons.Plus size={20} /></button></div></div><div className="flex flex-col gap-2 pt-2"><button type="submit" className="w-full bg-indigo-600 text-white py-4 rounded-[2rem] font-black text-xl shadow-lg active:scale-95 transition-all">保存する</button><button type="button" onClick={() => setEditingCalendar(null)} className="py-2 text-slate-400 font-bold text-xs">キャンセル</button></div></div></form></div>
                            )}
                        </>
                    ) : null}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
