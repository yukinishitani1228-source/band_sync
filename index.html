<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BandSync - バンド日程調整ツール</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', 'Noto Sans JP', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .slot-transition { transition: background-color 0.15s ease, transform 0.1s ease; }
        
        @keyframes popIn {
            0% { transform: scale(0.5) translateY(20px); opacity: 0; }
            100% { transform: scale(1) translateY(0); opacity: 1; }
        }
        .animate-pop-in { animation: popIn 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }

        @keyframes modalFade {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .animate-modal { animation: modalFade 0.2s ease-out forwards; }

        .selection-active {
            box-shadow: inset 0 0 0 3px #4f46e5 !important;
            z-index: 20;
            outline: 2px solid white;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        const { useState, useEffect, useMemo, useCallback, useRef } = React;

        // --- Firebase Modules ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged, 
            GoogleAuthProvider, 
            signInWithPopup,
            signOut 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc, 
            collection, 
            onSnapshot, 
            updateDoc 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyAtOjrOa6EBSmpzEb5xOQSOK6WmRl3ALVo", 
            authDomain: "bandschedule-98f2c.firebaseapp.com",
            projectId: "bandschedule-98f2c",
            storageBucket: "bandschedule-98f2c.firebasestorage.app",
            messagingSenderId: "1017107663135",
            appId: "1:1017107663135:web:54771b17cd463b32af482a"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appIdPrefix = 'band-sync-stable-v9'; 
        const GOOGLE_CLIENT_ID = "331455156682-9r9jn1jokcdvlm0blsdl5hued8adfmnj.apps.googleusercontent.com";

        // --- 定数 ---
        const START_HOUR = 8;
        const END_HOUR = 23;
        const SLOTS_PER_HOUR = 2; 
        const TOTAL_SLOTS = (END_HOUR - START_HOUR + 1) * SLOTS_PER_HOUR; 
        const DAYS_OF_WEEK = ['日', '月', '火', '水', '木', '金', '土'];

        // --- ヘルパー ---
        const formatDate = (date) => {
            const y = date.getFullYear();
            const m = (date.getMonth() + 1).toString().padStart(2, '0');
            const d = date.getDate().toString().padStart(2, '0');
            return `${y}-${m}-${d}`;
        };

        const getDatesInRange = (startDate, endDate) => {
            const dates = [];
            let current = new Date(startDate);
            const last = new Date(endDate);
            let count = 0;
            while (current <= last && count < 62) {
                dates.push(new Date(current));
                current.setDate(current.getDate() + 1);
                count++;
            }
            return dates;
        };

        const getWeekDatesWithinRange = (viewStart, rangeStart, rangeEnd) => {
            if (!viewStart) return [];
            const dates = [];
            const rStart = new Date(rangeStart);
            rStart.setHours(0,0,0,0);
            const rEnd = new Date(rangeEnd);
            rEnd.setHours(23,59,59,999);

            for (let i = 0; i < 7; i++) {
                const d = new Date(viewStart);
                d.setDate(viewStart.getDate() + i);
                if (d >= rStart && d <= rEnd) {
                    dates.push(d);
                }
            }
            return dates;
        };

        const generateId = () => Math.random().toString(36).substring(2, 11);

        // --- アイコン ---
        const IconGoogle = () => <svg className="w-5 h-5 mr-2" viewBox="0 0 24 24"><path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z"/><path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>;
        const IconCopy = () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>;
        const IconLogout = () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>;
        const IconExternal = () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>;
        const IconCircleOK = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="4" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/></svg>;
        const IconCalendar = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>;
        const IconSuta = () => (
            <div className="w-5 h-5 flex items-center justify-center font-black text-[10px] leading-none tracking-tighter">スタ</div>
        );

        // --- サブコンポーネント ---
        function LoadingView() {
            return (
                <div className="h-screen flex flex-col items-center justify-center font-black text-slate-300 animate-pulse italic uppercase bg-white">
                    <div className="w-10 h-10 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin mb-4 text-indigo-600"></div>
                    LOADING...
                </div>
            );
        }

        function ErrorView({ message, onRetry }) {
            return (
                <div className="min-h-screen flex items-center justify-center p-6 bg-rose-50 text-slate-900 font-sans">
                    <div className="bg-white p-8 rounded-3xl shadow-xl border border-rose-100 max-w-md w-full text-center">
                        <h1 className="text-xl font-black text-rose-600 mb-4 uppercase italic">ERROR</h1>
                        <p className="text-sm text-slate-600 mb-6 leading-relaxed whitespace-pre-wrap">{message}</p>
                        <button onClick={onRetry} className="w-full py-3 bg-rose-600 text-white rounded-xl font-bold uppercase hover:bg-rose-700 transition-all text-center">やり直す</button>
                    </div>
                </div>
            );
        }

        function AuthGate({ onGoogle, onAnon }) {
            return (
                <div className="min-h-screen bg-indigo-600 flex items-center justify-center p-6 text-white text-center">
                    <div className="w-full max-w-sm bg-white text-slate-900 p-8 rounded-[2.5rem] shadow-2xl">
                        <div className="w-16 h-16 bg-indigo-600 rounded-2xl flex items-center justify-center shadow-xl mx-auto mb-6 text-white italic font-black text-2xl shadow-indigo-100">B</div>
                        <h1 className="text-3xl font-black mb-1 text-indigo-600 italic tracking-tighter leading-tight font-sans text-indigo-600">BandSync</h1>
                        <p className="text-[10px] text-slate-400 font-bold mb-10 uppercase tracking-widest leading-relaxed">練習日程をみんなで共有しよう</p>
                        <div className="space-y-4">
                            <button onClick={onGoogle} className="w-full py-5 bg-indigo-600 text-white rounded-2xl font-black flex items-center justify-center hover:bg-indigo-700 shadow-xl shadow-indigo-100 transition-all text-sm font-sans text-white">
                                <IconGoogle /> Googleアカウントでログイン
                            </button>
                            <div className="py-2 flex items-center text-slate-300 text-[10px] font-bold uppercase tracking-widest before:flex-1 before:border-t before:mr-3 after:flex-1 after:border-t after:ml-3 font-sans">または</div>
                            <button onClick={onAnon} className="w-full py-4 bg-slate-50 text-slate-500 rounded-2xl font-bold text-sm hover:bg-slate-100 transition-all text-slate-500 font-sans">名前だけで始める（匿名）</button>
                        </div>
                    </div>
                </div>
            );
        }

        function Landing({ onCreate, user, onLogout }) {
            const [name, setName] = useState('');
            const [num, setNum] = useState(4);
            const [startDate, setStartDate] = useState(formatDate(new Date()));
            const [endDate, setEndDate] = useState(() => {
                const d = new Date(); d.setDate(d.getDate() + 14); return formatDate(d);
            });
            const isAnon = user.isAnonymous;
            return (
                <div className="min-h-screen bg-indigo-600 flex items-center justify-center p-6 text-white text-center font-sans">
                    <div className="w-full max-w-sm bg-white text-slate-900 p-8 rounded-[2.5rem] shadow-2xl">
                        <div className="flex items-center justify-between mb-8 border-b pb-6 text-left">
                            <div className="flex items-center gap-3">
                                {user.photoURL ? <img src={user.photoURL} className="w-10 h-10 rounded-full shadow-sm" /> : <div className="w-10 h-10 bg-indigo-100 rounded-full flex items-center justify-center text-indigo-600 font-black italic">U</div>}
                                <div>
                                    <p className="text-[9px] font-bold text-slate-400 uppercase leading-none mb-1">{isAnon ? "GUEST" : "LOGGED IN"}</p>
                                    <p className="font-black text-sm truncate w-32 text-slate-900 font-sans">{user.displayName || "ゲストユーザー"}</p>
                                </div>
                            </div>
                            <button onClick={onLogout} className="text-slate-300 hover:text-rose-500 transition-colors p-2 text-left"><IconLogout /></button>
                        </div>
                        <div className="space-y-6 text-slate-900 text-left">
                            <div>
                                <label className="text-[10px] font-black text-slate-400 block mb-2 uppercase tracking-widest text-center font-sans">調整プロジェクト名</label>
                                <input className="w-full p-4 bg-slate-50 border-none rounded-2xl font-black text-lg text-center focus:ring-2 focus:ring-indigo-500 outline-none text-slate-900 font-sans" placeholder="例: LIVE練習" value={name} onChange={e => setName(e.target.value)} />
                            </div>
                            <div className="grid grid-cols-2 gap-3">
                                <div><label className="text-[10px] font-black text-slate-400 block mb-2 uppercase tracking-widest text-center font-sans">開始日</label><input type="date" className="w-full p-3 bg-slate-50 border-none rounded-xl font-bold text-sm text-center focus:ring-2 focus:ring-indigo-500 outline-none text-slate-900 font-sans" value={startDate} onChange={e => setStartDate(e.target.value)} /></div>
                                <div><label className="text-[10px] font-black text-slate-400 block mb-2 uppercase tracking-widest text-center font-sans">終了日</label><input type="date" className="w-full p-3 bg-slate-50 border-none rounded-xl font-bold text-sm text-center focus:ring-2 focus:ring-indigo-500 outline-none text-slate-900 font-sans" value={endDate} onChange={e => setEndDate(e.target.value)} /></div>
                            </div>
                            <div>
                                <label className="text-[10px] font-black text-slate-400 block mb-2 uppercase tracking-widest text-center font-sans">目標人数</label>
                                <div className="flex items-center justify-between gap-4 font-sans">
                                    <button onClick={() => setNum(Math.max(1, num - 1))} className="w-14 h-14 bg-slate-100 rounded-2xl text-xl font-black hover:bg-slate-200 transition-colors text-slate-900 font-sans">-</button>
                                    <div className="text-center flex-1"><span className="text-4xl font-black tabular-nums text-slate-900">{num}</span><span className="text-xs font-bold ml-1 text-slate-400 uppercase">人</span></div>
                                    <button onClick={() => setNum(num + 1)} className="w-14 h-14 bg-slate-100 rounded-2xl text-xl font-black hover:bg-slate-200 transition-colors text-slate-900 font-sans">+</button>
                                </div>
                            </div>
                            <button disabled={!name || new Date(startDate) > new Date(endDate)} onClick={() => onCreate(name, num, startDate, endDate)} className="w-full py-5 bg-indigo-600 text-white rounded-2xl font-black shadow-xl shadow-indigo-100 hover:bg-indigo-700 transition-all text-center text-white disabled:opacity-50">
                                カレンダーを作成
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        function JoinView({ bandName, userName, setUserName, onJoin, isJoining }) {
            return (
                <div className="min-h-screen bg-indigo-600 flex items-center justify-center p-4 text-slate-900 text-left font-sans">
                    <div className="bg-white p-8 rounded-[2.5rem] shadow-2xl w-full max-w-sm text-center">
                        <h1 className="text-xl font-black mb-2 text-indigo-600 italic text-center text-indigo-600 font-sans">BandSync</h1>
                        <p className="text-sm font-bold mb-8 text-slate-400 uppercase tracking-widest leading-tight text-center font-sans">{bandName}</p>
                        <input className="w-full p-4 bg-slate-50 border-none rounded-2xl font-black text-lg text-center focus:ring-2 focus:ring-indigo-500 outline-none mb-4 text-slate-900 font-sans" placeholder="あなたの表示名" value={userName || ''} onChange={e => setUserName(e.target.value)} />
                        <button onClick={onJoin} disabled={!userName || !userName.trim() || isJoining} className="w-full py-5 bg-indigo-600 text-white rounded-2xl font-black shadow-lg hover:bg-indigo-700 transition-all disabled:opacity-50 text-center text-white font-sans">
                            {isJoining ? "処理中..." : "カレンダーを表示"}
                        </button>
                    </div>
                </div>
            );
        }

        // --- Main App Component ---
        function App() {
            const [user, setUser] = useState(null);
            const [isAuthLoading, setIsAuthLoading] = useState(true);
            const [error, setError] = useState(null);
            const [sessionId, setSessionId] = useState(new URLSearchParams(window.location.search).get('s') || null);
            const [sessionData, setSessionData] = useState(null);
            const [allAvailability, setAllAvailability] = useState([]);
            const [userName, setUserName] = useState('');
            const [isJoined, setIsJoined] = useState(false);
            const [isJoining, setIsJoining] = useState(false);
            const [viewStartDate, setViewStartDate] = useState(null);
            const [peekSlot, setPeekSlot] = useState(null);
            const [selectionStart, setSelectionStart] = useState(null);
            const [showMatchModal, setShowMatchModal] = useState(false);
            const [showStudioModal, setShowStudioModal] = useState(false);
            const [isSyncing, setIsSyncing] = useState(false);
            const [googleToken, setGoogleToken] = useState(null);
            
            const longPressTimer = useRef(null);
            const isLongPressing = useRef(false);

            // Auth Listener
            useEffect(() => {
                const unsub = onAuthStateChanged(auth, (u) => {
                    setUser(u);
                    setIsAuthLoading(false);
                    if (u && !userName) setUserName(u.displayName || '');
                });
                return () => unsub();
            }, [userName]);

            // Data Listener
            useEffect(() => {
                if (!user || !sessionId) return;
                const sessionRef = doc(db, 'artifacts', appIdPrefix, 'public', 'data', 'sessions', sessionId);
                const unsubSession = onSnapshot(sessionRef, (snap) => {
                    if (snap.exists()) {
                        const data = snap.data();
                        setSessionData(data);
                        // ここで確実にviewStartDateを初期化
                        setViewStartDate(prev => prev || new Date(data.startDate));
                    } else {
                        setError("セッションが見つかりませんでした。URLが正しいか確認してください。");
                    }
                }, (err) => {
                    console.error("Firestore error:", err);
                    setError("データの読み取りに失敗しました。");
                });

                const availCol = collection(db, 'artifacts', appIdPrefix, 'public', 'data', 'availability');
                const unsubAvail = onSnapshot(availCol, (snap) => {
                    const docs = [];
                    snap.forEach(d => docs.push({ id: d.id, ...d.data() }));
                    const filtered = docs.filter(item => item.sessionId === sessionId);
                    setAllAvailability(filtered);
                    const me = filtered.find(item => item.uid === user.uid);
                    if (me) {
                        setIsJoined(true);
                        setUserName(me.name);
                    }
                });
                return () => { unsubSession(); unsubAvail(); };
            }, [user, sessionId]);

            const loginWithGoogle = async (forceSelect = false) => {
                const provider = new GoogleAuthProvider();
                provider.addScope('https://www.googleapis.com/auth/calendar.readonly');
                if (forceSelect) provider.setCustomParameters({ prompt: 'select_account' });
                try {
                    const result = await signInWithPopup(auth, provider);
                    const credential = GoogleAuthProvider.credentialFromResult(result);
                    setGoogleToken(credential.accessToken);
                    return credential.accessToken;
                } catch (e) {
                    console.error(e);
                    if (e.code === 'auth/popup-blocked') alert("ポップアップがブロックされました。");
                    return null;
                }
            };

            const handleLogout = async () => {
                if (confirm("ログアウトしますか？")) { await signOut(auth); window.location.reload(); }
            };

            const handleCreate = async (name, count, start, end) => {
                if (!user) return;
                const id = generateId();
                const data = { id, bandName: name, memberCount: parseInt(count), startDate: start, endDate: end, createdAt: Date.now(), creatorUid: user.uid };
                try {
                    await setDoc(doc(db, 'artifacts', appIdPrefix, 'public', 'data', 'sessions', id), data);
                    setSessionId(id);
                } catch (e) { setError(`作成失敗: ${e.message}`); }
            };

            const handleJoin = async () => {
                if (!userName || !userName.trim() || !user || !sessionId) return;
                setIsJoining(true);
                try {
                    const docId = `${sessionId}_${user.uid}`;
                    const ref = doc(db, 'artifacts', appIdPrefix, 'public', 'data', 'availability', docId);
                    const myExistingData = allAvailability.find(a => a.uid === user.uid);
                    await setDoc(ref, { 
                        sessionId, uid: user.uid, name: userName.trim(), 
                        slots: myExistingData?.slots || [], photoURL: user.photoURL || null, lastUpdated: Date.now()
                    }, { merge: true });
                    setIsJoined(true);
                } catch (e) { setError(`参加に失敗しました。`); } finally { setIsJoining(false); }
            };

            const syncCalendar = async (retryToken = null) => {
                if (!user || user.isAnonymous) return;
                setIsSyncing(true);
                let token = retryToken || googleToken;
                if (!token) token = await loginWithGoogle(true);
                if (!token) { setIsSyncing(false); return; }

                try {
                    const dates = getWeekDatesWithinRange(viewStartDate, sessionData.startDate, sessionData.endDate);
                    const timeMin = new Date(dates[0]); timeMin.setHours(0,0,0,0);
                    const timeMax = new Date(dates[dates.length-1]); timeMax.setHours(23,59,59,999);

                    const resp = await fetch(`https://www.googleapis.com/calendar/v3/calendars/primary/events?timeMin=${timeMin.toISOString()}&timeMax=${timeMax.toISOString()}&singleEvents=true`, {
                        headers: { Authorization: `Bearer ${token}` }
                    });

                    if (resp.status === 401 || resp.status === 403) {
                        const newToken = await loginWithGoogle(true);
                        if (newToken) return syncCalendar(newToken);
                        throw new Error("権限エラー");
                    }

                    const data = await resp.json();
                    const events = data.items.map(e => ({ start: new Date(e.start.dateTime || e.start.date), end: new Date(e.end.dateTime || e.end.date) }));
                    const newSlots = [];
                    dates.forEach(date => {
                        const ds = formatDate(date);
                        for (let sIdx = 0; sIdx < TOTAL_SLOTS; sIdx++) {
                            const slotStart = new Date(date); slotStart.setHours(START_HOUR + Math.floor(sIdx / 2), (sIdx % 2) * 30, 0, 0);
                            const slotEnd = new Date(slotStart); slotEnd.setMinutes(slotEnd.getMinutes() + 30);
                            if (!events.some(e => (slotStart < e.end && slotEnd > e.start))) newSlots.push(`${ds}:${sIdx}`);
                        }
                    });

                    const docId = `${sessionId}_${user.uid}`;
                    await updateDoc(doc(db, 'artifacts', appIdPrefix, 'public', 'data', 'availability', docId), { slots: newSlots });
                    alert("同期完了！");
                } catch (e) { alert("同期エラー。設定を再確認してください。"); } finally { setIsSyncing(false); }
            };

            const handleSlotClick = async (dateStr, slotIdx) => {
                if (!isJoined || !user || !sessionId) return;
                const docId = `${sessionId}_${user.uid}`;
                const ref = doc(db, 'artifacts', appIdPrefix, 'public', 'data', 'availability', docId);
                const myData = allAvailability.find(a => a.uid === user.uid);
                const myCurrentSlots = myData?.slots || [];
                const amISelected = myCurrentSlots.includes(`${dateStr}:${slotIdx}`);

                if (!selectionStart || selectionStart.dateStr !== dateStr) {
                    setSelectionStart({ dateStr, slotIdx, wasSelected: amISelected });
                } else {
                    const start = Math.min(selectionStart.slotIdx, slotIdx);
                    const end = Math.max(selectionStart.slotIdx, slotIdx);
                    const rangeKeys = [];
                    for (let i = start; i <= end; i++) rangeKeys.push(`${dateStr}:${i}`);
                    const nextSlots = selectionStart.wasSelected ? myCurrentSlots.filter(s => !rangeKeys.includes(s)) : Array.from(new Set([...myCurrentSlots, ...rangeKeys]));
                    setSelectionStart(null);
                    await updateDoc(ref, { slots: nextSlots });
                }
            };

            const slotDetails = useMemo(() => {
                const map = {};
                allAvailability.forEach(data => {
                    data.slots?.forEach(slotKey => { if (!map[slotKey]) map[slotKey] = []; map[slotKey].push({ uid: data.uid, name: data.name, photoURL: data.photoURL }); });
                });
                return map;
            }, [allAvailability]);

            const matchedRanges = useMemo(() => {
                if (!sessionData) return [];
                const results = [];
                getDatesInRange(sessionData.startDate, sessionData.endDate).forEach(date => {
                    const ds = formatDate(date); let currentRange = null;
                    for (let sIdx = 0; sIdx < TOTAL_SLOTS; sIdx++) {
                        if ((slotDetails[`${ds}:${sIdx}`]?.length || 0) >= sessionData.memberCount) {
                            if (!currentRange) currentRange = { start: sIdx }; currentRange.end = sIdx;
                        } else if (currentRange) { results.push({ date: new Date(date), ...currentRange }); currentRange = null; }
                    }
                    if (currentRange) results.push({ date: new Date(date), ...currentRange });
                });
                return results;
            }, [sessionData, slotDetails]);

            const onSlotPointerDown = (key) => {
                isLongPressing.current = false;
                longPressTimer.current = setTimeout(() => { isLongPressing.current = true; setPeekSlot(key); }, 400);
            };
            const onSlotPointerUp = (key, ds, sIdx) => {
                clearTimeout(longPressTimer.current);
                if (!isLongPressing.current) handleSlotClick(ds, sIdx);
                setPeekSlot(null); isLongPressing.current = false;
            };

            if (error) return <ErrorView message={error} onRetry={() => { setError(null); window.location.reload(); }} />;
            if (isAuthLoading) return <LoadingView />;
            if (!user) return <AuthGate onGoogle={() => loginWithGoogle()} onAnon={() => signInAnonymously(auth)} />;
            if (!sessionId) return <Landing onCreate={handleCreate} user={user} onLogout={handleLogout} />;
            if (!sessionData || !viewStartDate) return <LoadingView />;
            if (!isJoined) return <JoinView bandName={sessionData.bandName} userName={userName} setUserName={setUserName} onJoin={handleJoin} isJoining={isJoining} />;

            const weekDates = getWeekDatesWithinRange(viewStartDate, sessionData.startDate, sessionData.endDate);
            const canGoPrev = viewStartDate > new Date(sessionData.startDate);
            const canGoNext = (() => { const n = new Date(viewStartDate); n.setDate(n.getDate()+7); return n <= new Date(sessionData.endDate); })();

            return (
                <div className="h-screen bg-white flex flex-col font-sans overflow-hidden relative text-slate-900">
                    <header className="px-4 py-3 border-b flex justify-between items-center bg-white z-[60] shrink-0 shadow-sm">
                        <div className="min-w-0">
                            <div className="font-black text-lg text-indigo-600 truncate leading-tight">{sessionData.bandName}</div>
                            <div className="text-[10px] text-slate-400 font-bold uppercase tracking-wider flex items-center gap-2"><span>目標: {sessionData.memberCount}人</span><span>参加: {allAvailability.length}人</span></div>
                        </div>
                        <div className="flex gap-1.5">
                            {user && !user.isAnonymous && (
                                <button onClick={() => syncCalendar()} disabled={isSyncing} className={`p-2.5 rounded-xl transition-colors ${isSyncing ? 'animate-pulse' : ''} bg-indigo-50 text-indigo-600 hover:bg-indigo-100`} title="同期"><IconCalendar /></button>
                            )}
                            <button onClick={() => setShowMatchModal(true)} className="p-2.5 bg-emerald-50 text-emerald-500 rounded-xl hover:bg-emerald-100 relative"><IconCircleOK />{matchedRanges.length > 0 && <div className="absolute -top-1 -right-1 w-4 h-4 bg-emerald-500 text-white text-[8px] font-black rounded-full flex items-center justify-center border-2 border-white">{matchedRanges.length}</div>}</button>
                            <button onClick={() => setShowStudioModal(true)} className="p-2.5 bg-amber-50 text-amber-600 rounded-xl hover:bg-amber-100"><IconSuta /></button>
                            <button onClick={() => { const t = document.createElement('textarea'); t.value = window.location.origin + window.location.pathname + '?s=' + sessionId; document.body.appendChild(t); t.select(); document.execCommand('copy'); document.body.removeChild(t); alert('URLをコピーしました！'); }} className="p-2.5 bg-indigo-50 text-indigo-600 rounded-xl hover:bg-indigo-100 font-sans"><IconCopy /></button>
                            <button onClick={handleLogout} className="p-2.5 bg-slate-50 text-slate-400 rounded-xl hover:bg-rose-50 hover:text-rose-500"><IconLogout /></button>
                        </div>
                    </header>

                    <div className="flex items-center justify-between px-4 py-2 border-b bg-slate-50 shrink-0 font-sans">
                        <button disabled={!canGoPrev} onClick={() => { const n = new Date(viewStartDate); n.setDate(n.getDate()-7); setViewStartDate(n); }} className={`text-xs font-black p-1 ${!canGoPrev ? 'opacity-20 pointer-events-none' : 'text-slate-400'}`}>← 前週</button>
                        <span className="font-black text-sm text-slate-700">{viewStartDate.toLocaleDateString('ja-JP', { year: 'numeric', month: 'short' })}</span>
                        <button disabled={!canGoNext} onClick={() => { const n = new Date(viewStartDate); n.setDate(n.getDate()+7); setViewStartDate(n); }} className={`text-xs font-black p-1 ${!canGoNext ? 'opacity-20 pointer-events-none' : 'text-slate-400'}`}>次週 →</button>
                    </div>

                    <div className="flex-1 flex flex-col overflow-y-auto no-scrollbar pb-10 bg-white">
                        <div className="w-full flex border-b sticky top-0 bg-white z-10 shadow-sm text-center">
                            <div className="w-12 shrink-0 border-r bg-slate-50"></div>
                            {weekDates.map((d, i) => (
                                <div key={i} className="flex-1 py-2 border-r last:border-r-0 font-sans"><div className={`text-[10px] font-bold ${d.getDay() === 0 ? 'text-rose-500' : d.getDay() === 6 ? 'text-blue-500' : 'text-slate-400'}`}>{DAYS_OF_WEEK[d.getDay()]}</div><div className="font-black text-sm text-slate-700">{d.getDate()}</div></div>
                            ))}
                            {Array.from({ length: 7 - weekDates.length }).map((_, i) => <div key={'e-'+i} className="flex-1 bg-slate-50/50 border-r last:border-r-0"></div>)}
                        </div>

                        <div className="flex w-full relative">
                            <div className="w-12 shrink-0 bg-slate-50/50 border-r text-[9px] text-slate-400 font-black text-center">{Array.from({ length: END_HOUR - START_HOUR + 1 }).map((_, h) => <div key={h} className="h-12 flex items-start justify-center pt-2 border-b border-slate-100 font-sans">{START_HOUR + h}:00</div>)}</div>
                            <div className="flex-1 flex">
                                {weekDates.map((d, dayIdx) => {
                                    const ds = formatDate(d);
                                    return (
                                        <div key={dayIdx} className="flex-1 border-r last:border-r-0 flex flex-col relative font-sans">
                                            {Array.from({ length: TOTAL_SLOTS }).map((_, sIdx) => {
                                                const key = `${ds}:${sIdx}`; const participants = slotDetails[key] || []; const count = participants.length;
                                                const isMe = allAvailability.find(a => a.uid === user.uid)?.slots?.includes(key); const isFull = count >= sessionData.memberCount;
                                                const isPeeking = peekSlot === key; const isSStart = selectionStart && selectionStart.dateStr === ds && selectionStart.slotIdx === sIdx;
                                                let cellBg = isFull ? '#ef4444' : count > 0 ? `rgba(67, 56, 202, ${0.25 + (count/sessionData.memberCount * 0.7)})` : 'transparent';
                                                return (
                                                    <div key={sIdx} onPointerDown={() => onSlotPointerDown(key)} onPointerUp={() => onSlotPointerUp(key, ds, sIdx)} onPointerLeave={() => setPeekSlot(null)} style={{ backgroundColor: cellBg }} className={`h-6 border-b border-slate-100 cursor-pointer relative slot-transition select-none ${isMe ? 'ring-1 ring-inset ring-white/40 shadow-inner' : ''} ${isPeeking ? 'z-50' : ''} ${isSStart ? 'selection-active' : ''}`}>
                                                        {isMe && <div className="absolute inset-0 flex items-center justify-center opacity-40 pointer-events-none"><div className="w-1 h-1 bg-white rounded-full"></div></div>}
                                                        {count > 0 && <div className={`absolute inset-0 flex items-center justify-center text-[8px] font-black pointer-events-none ${isFull || count >= sessionData.memberCount/2 ? 'text-white font-sans' : 'text-indigo-900/40 font-sans'}`}>{count}</div>}
                                                        {isPeeking && participants.length > 0 && (
                                                            <div className="absolute top-1/2 left-full ml-3 -translate-y-1/2 bg-white/98 backdrop-blur shadow-2xl rounded-3xl p-3 border border-slate-200 flex flex-wrap max-w-[200px] gap-2 z-[100] animate-pop-in pointer-events-none text-left font-sans font-sans font-sans font-sans">
                                                                {participants.map((p) => (
                                                                    <div key={p.uid} className="w-10 h-10 rounded-2xl border-2 border-white shadow-md overflow-hidden flex-shrink-0 bg-indigo-100 flex items-center justify-center">{p.photoURL ? <img src={p.photoURL} className="w-full h-full object-cover" /> : <span className="text-sm font-black text-indigo-600 uppercase font-sans font-sans">{p.name?.charAt(0) || '?'}</span>}</div>
                                                                ))}
                                                            </div>
                                                        )}
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    </div>

                    {/* Modals */}
                    {showMatchModal && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center p-4">
                            <div className="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onClick={() => setShowMatchModal(false)}></div>
                            <div className="bg-white w-full max-w-sm rounded-[2.5rem] shadow-2xl p-8 relative animate-modal max-h-[80vh] flex flex-col font-sans">
                                <div className="flex justify-between items-center mb-6 text-emerald-500"><div className="flex items-center gap-2"><IconCircleOK /><h2 className="text-xl font-black italic tracking-tighter font-sans">全員OKの時間</h2></div><button onClick={() => setShowMatchModal(false)} className="text-slate-300 hover:text-slate-500 p-2 font-sans font-sans font-sans"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div>
                                <div className="flex-1 overflow-y-auto no-scrollbar space-y-3 font-sans">
                                    {matchedRanges.length > 0 ? matchedRanges.map((m, idx) => {
                                        const sH = START_HOUR + Math.floor(m.start / 2); const sM = m.start % 2 === 0 ? "00" : "30";
                                        const eH = START_HOUR + Math.floor((m.end + 1) / 2); const eM = (m.end + 1) % 2 === 0 ? "00" : "30";
                                        return (
                                            <div key={idx} className="bg-slate-50 p-4 rounded-2xl flex items-center justify-between border border-slate-100 group hover:border-emerald-200 transition-all font-sans font-sans font-sans font-sans"><div className="font-black text-slate-800 text-sm font-sans font-sans">{`${m.date.getMonth() + 1}/${m.date.getDate()}(${DAYS_OF_WEEK[m.date.getDay()]})`}</div><div className="bg-white px-3 py-1 rounded-full text-xs font-black text-emerald-500 shadow-sm font-sans font-sans">{sH}:{sM} 〜 {eH}:{eM}</div></div>
                                        );
                                    }) : <div className="py-12 text-center text-slate-300 font-sans font-sans font-sans">全員が集まれる時間は<br/>まだありません</div>}
                                </div>
                                <p className="mt-6 text-[10px] text-slate-300 font-bold text-center uppercase tracking-widest font-sans font-sans font-sans font-sans font-sans">Powered by BandSync</p>
                            </div>
                        </div>
                    )}

                    {showStudioModal && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 font-sans">
                            <div className="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onClick={() => setShowStudioModal(false)}></div>
                            <div className="bg-white w-full max-w-sm rounded-[2.5rem] shadow-2xl p-8 relative animate-modal max-h-[80vh] flex flex-col font-sans">
                                <div className="flex justify-between items-center mb-6 text-amber-500"><div className="flex items-center gap-2"><div className="bg-amber-100 px-2 py-1 rounded-lg text-[10px] font-black font-sans">スタ</div><h2 className="text-xl font-black italic tracking-tighter">Studio Booking</h2></div><button onClick={() => setShowStudioModal(false)} className="text-slate-300 hover:text-slate-500 p-2 font-sans font-sans"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div>
                                <div className="flex-1 overflow-y-auto no-scrollbar space-y-4 font-sans font-sans">
                                    {[
                                        { name: 'ゲートウェイ高田馬場3号店', url: 'http://www.gw-studio.com/studios/studio_baba3rd/index' },
                                        { name: 'バズーカスタジオ高田馬場', url: 'https://bazookastudio.com/' },
                                        { name: 'BASS ON TOP高田馬場', url: 'https://www.bassontop.co.jp/band/takadanobaba/' }
                                    ].map(s => (
                                        <a key={s.url} href={s.url} target="_blank" className="flex items-center justify-between p-4 bg-slate-50 rounded-2xl border border-slate-100 hover:border-amber-300 hover:bg-amber-50/30 transition-all group">
                                            <div className="text-left"><div className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-0.5">Takadanobaba</div><div className="font-black text-slate-700 text-sm font-sans">{s.name}</div></div><div className="text-slate-300 group-hover:text-amber-500 font-sans"><IconExternal /></div>
                                        </a>
                                    ))}
                                </div>
                                <p className="mt-6 text-[10px] text-slate-300 font-bold text-center uppercase tracking-widest font-sans font-sans font-sans">Powered by BandSync</p>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
